using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Cors;
using Microsoft.Extensions.Logging;
using SimpleAnalytics.Api.Models;
using SimpleAnalytics.Api.Services;

namespace SimpleAnalytics.Api.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    // Tarayıcıdan gelen isteklere izin vermek için (Program.cs'deki isimle aynı olmalı)
    [EnableCors("AllowAll")]
    public class CollectorController : ControllerBase
    {
        private readonly IAnalyticsService _analyticsService;
        private readonly ILogger<CollectorController> _logger;

        // Dependency Injection ile Servisi içeri alıyoruz
        public CollectorController(IAnalyticsService analyticsService, ILogger<CollectorController> logger)
        {
            _analyticsService = analyticsService;
            _logger = logger;
        }

        [HttpPost("track")]
        public async Task<IActionResult> Track([FromBody] VisitDto data)
        {
            // 1. ADIM: Gelen ApiKey ile websitesini doğrula
            var website = await _analyticsService.GetWebsiteByApiKey(data.ApiKey);

            if (website == null)
            {
                _logger.LogWarning("Geçersiz API Key ile istek: {ApiKey}", data?.ApiKey);
                return Unauthorized("Geçersiz API Key.");
            }

            // 2. ADIM: JavaScript'ten gelen (DTO) veriyi, Veritabanı Modeline (Visit) aktar
            var visit = new Visit
            {
                WebsiteId = website.Id,
                Path = data.Path,
                Referrer = data.Referrer,
                UserAgent = data.UserAgent,
                CreatedAt = DateTime.UtcNow
            };

            // 3. ADIM: Servis üzerinden kaydı tamamla
            try
            {
                var ok = await _analyticsService.TrackVisit(visit);
                if (!ok)
                {
                    _logger.LogError("TrackVisit döndü: false. WebsiteId: {WebsiteId}, Path: {Path}", visit.WebsiteId, visit.Path);
                    return StatusCode(500, "Kayıt yapılamadı.");
                }
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Visit kaydı sırasında exception oluştu. WebsiteId: {WebsiteId}, Path: {Path}", visit.WebsiteId, visit.Path);
                return StatusCode(500, "Sunucu hatası: kayıt başarısız.");
            }

            return Ok(new { status = "success" });
        }
    }

    /// <summary>
    /// JavaScript'ten gelen JSON paketini karşılayan sınıftır.
    /// JSON anahtarları ile buradaki isimler eşleşmelidir.
    /// </summary>
    public class VisitDto
    {
        public string ApiKey { get; set; }
        public string Path { get; set; }
        public string Referrer { get; set; }
        public string UserAgent { get; set; }
    }
}